name: "Setup Backend Infrastructure (One-Time)"

on:
  workflow_dispatch:  # Only run manually

env:
  AWS_REGION: "us-west-2"
  TF_VERSION: "1.6.0"

jobs:
  setup-backend:
    name: "Create S3 & DynamoDB for State"
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Create backend-only configuration
        run: |
          cat > backend-init.tf << 'EOF'
          terraform {
            required_providers {
              aws = {
                source  = "hashicorp/aws"
                version = "4.52.0"
              }
            }
          }

          provider "aws" {
            region = "us-west-2"
          }

          resource "aws_s3_bucket" "terraform_state" {
            bucket = "your-terraform-state-detection-lab"  # CHANGE THIS!

            tags = {
              Name        = "Terraform State Bucket"
              Environment = "Lab"
            }
          }

          resource "aws_s3_bucket_versioning" "terraform_state" {
            bucket = aws_s3_bucket.terraform_state.id

            versioning_configuration {
              status = "Enabled"
            }
          }

          resource "aws_s3_bucket_server_side_encryption_configuration" "terraform_state" {
            bucket = aws_s3_bucket.terraform_state.id

            rule {
              apply_server_side_encryption_by_default {
                sse_algorithm = "AES256"
              }
            }
          }

          resource "aws_s3_bucket_public_access_block" "terraform_state" {
            bucket = aws_s3_bucket.terraform_state.id

            block_public_acls       = true
            block_public_policy     = true
            ignore_public_acls      = true
            restrict_public_buckets = true
          }

          resource "aws_dynamodb_table" "terraform_locks" {
            name         = "terraform-state-lock"
            billing_mode = "PAY_PER_REQUEST"
            hash_key     = "LockID"

            attribute {
              name = "LockID"
              type = "S"
            }

            tags = {
              Name        = "Terraform State Lock Table"
              Environment = "Lab"
            }
          }

          output "s3_bucket_name" {
            value = aws_s3_bucket.terraform_state.id
          }

          output "dynamodb_table_name" {
            value = aws_dynamodb_table.terraform_locks.name
          }
          EOF

      - name: Terraform Init
        run: terraform init

      - name: Terraform Plan
        run: terraform plan -out=backend-plan

      - name: Terraform Apply
        run: terraform apply -auto-approve backend-plan

      - name: Display Backend Information
        run: |
          echo "âœ… Backend infrastructure created successfully!"
          echo ""
          echo "ðŸ“ Update your main.tf backend configuration with:"
          echo "   bucket = \"$(terraform output -raw s3_bucket_name)\""
          echo "   dynamodb_table = \"$(terraform output -raw dynamodb_table_name)\""
          echo ""
          echo "âš ï¸  IMPORTANT: After updating main.tf, you can delete this workflow file!"

      - name: Create Summary
        run: |
          echo "## Backend Setup Complete! ðŸŽ‰" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Resources Created:" >> $GITHUB_STEP_SUMMARY
          echo "- S3 Bucket: \`$(terraform output -raw s3_bucket_name)\`" >> $GITHUB_STEP_SUMMARY
          echo "- DynamoDB Table: \`$(terraform output -raw dynamodb_table_name)\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Next Steps:" >> $GITHUB_STEP_SUMMARY
          echo "1. Update the backend configuration in \`main.tf\`" >> $GITHUB_STEP_SUMMARY
          echo "2. Delete or disable this workflow file" >> $GITHUB_STEP_SUMMARY
          echo "3. Push changes to trigger the main Terraform apply" >> $GITHUB_STEP_SUMMARY